#!/usr/bin/env ruby
#

require 'fileutils'

DUMMY_APP = File.expand_path('../../spec/dummy', __FILE__)
PLUGIN_PATH = File.join(DUMMY_APP, 'plugins/discourse_reports')
PATHS_TO_COPY = %w(
  app
  assets
  config
  lib
  spec/[^dummy]*
  plugin.rb
  Rakefile
  .jshintignore
  .jshintrc
)

# Clean up plugin path from spec/dummy app
FileUtils.rm_rf(PLUGIN_PATH) if File.exists?(PLUGIN_PATH)
FileUtils.mkdir_p(PLUGIN_PATH)

Dir.glob(PATHS_TO_COPY).each do |file|
  FileUtils.mkdir_p(File.dirname(File.join(PLUGIN_PATH, file)))

  FileUtils.cp_r(
    File.expand_path(file),
    File.join(PLUGIN_PATH, file)
  )
end

FileUtils.rm_rf(File.join(DUMMY_APP, 'test'))
FileUtils.cp_r(File.expand_path('../../test', __FILE__), File.join(DUMMY_APP, 'test'))

system(%(bundle install --gemfile #{File.join(DUMMY_APP, 'Gemfile')}))
FileUtils.cd(DUMMY_APP)

system('bundle exec rake plugin:spec[discourse_reports]')
system('bundle exec rake qunit:test')

FileUtils.rm_rf(PLUGIN_PATH) if File.exists?(PLUGIN_PATH)
